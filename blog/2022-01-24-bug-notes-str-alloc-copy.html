<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
        <title>Notes from debugging the Zephyr string copy function</title>
        <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA+Pj4AP+ZmQCZmf8A/zOZACkpKQCZADMA/zaaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABVVVVVAAAABTERERNQAABTEVEVETUAAFMVURVRNQAFZTUzM1NWUFZmVVVVVWZlVmRmZmZmRmVWREImYiREZVZEQiIiJEdlVkQmYiZiRGVWZCZiJmJGZQVkImImIkZQBWZCIiIkZlAAVmQiIkZlAAAFVmZmZVAAAAAFVVVQAADwDwAA4AcAAMADAADAAwAAgAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIABAACAAQAAwAMAAOAHAAD4HwAA" />
        <meta name="description" content="Debug notes, again">
        <meta property="og:title" content="Notes from debugging the Zephyr string copy function" />
        <meta property="og:description" content="Debug notes, again" />
        <meta property="og:type" content="website" />
        <meta property="og:locale" content="en_US" />
        <meta property="og:url" content="http://theotherjimmy.github.io/blog/" />
        <meta property="og:image" content="https://avatars.githubusercontent.com/u/685409?v=4" />
        <style>
body {
    font-family: Serif;
    font-size: 18px;
    margin: 0;
    background-color: #2e3440;
    color: #d8dee9;
    text-align: justify;
    text-justify: inter-word;
}

a:link {
    color: #81a1c1;
}

a:visited {
    color: #b48aed;
}

a:hover {
    background-color: #3b4252;
}

pre {
    overflow: auto;
}

main#content {
    margin: auto;
    padding-left: 2em;
    padding-right: 2em;
    max-width: 60em;
}

.navbar ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
}

.navbar li {
    float: left;
}

.navbar li a {
    display: block;
    text-align: center;
    padding: 0.5em 0.5em;
    text-decoration: none;
}

.flex-break {
  flex-basis: 100%;
  height: 0;
  display: none;
}

.list-posts .list-title {
  text-align: center;
}
.list-posts .posts-year {
  margin-top: 70px;
}
.list-posts .post-title {
  margin: 18px 0 0 15px;
}
.list-posts a {
  text-decoration: none;
}
.post-title .post-link,
.post-title .post-date {
  display: inline-block;
}
.post-title .post-link {
  width: 80%;
}
.tags-list .post-tags {
  margin-top: 50px;
}
.tags-list .post-tags .post-tag {
  margin: 2px 5px;
  padding: 0;
}
.tags-list .post-tags .post-tag a {
  border-radius: inherit;
  padding: 0;
}
.tags-list .post-tags .post-tag a div {
  display: inline-block;
}
.tags-list .post-tags .post-tag a .tag-name {
  padding: 5px 8px;
}
.tags-list .post-tags .post-tag a .tag-posts-count {
  background-color: var(--light-secondary-color);
  border-radius: inherit;
  color: inherit;
  opacity: 0.8;
  padding: 6px;
  position: relative;
  z-index: 0;
}
.tags-list .post-tags .post-tag:hover a .tag-posts-count {
  background-color: var(--light-text-color);
  color: rgb(var(--light-primary-color));
}

        </style>
    </head>
    <body>
        <header>
<nav class="navbar" role="navigation"><ul><li><a href="/blog/index.html">Blog</a></li>
<li style="float:right"><a href="https://github.com/theotherjimmy"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItZ2l0aHViIj48cGF0aCBkPSJNOSAxOWMtNSAxLjUtNS0yLjUtNy0zbTE0IDZ2LTMuODdhMy4zNyAzLjM3IDAgMCAwLS45NC0yLjYxYzMuMTQtLjM1IDYuNDQtMS41NCA2LjQ0LTdBNS40NCA1LjQ0IDAgMCAwIDIwIDQuNzcgNS4wNyA1LjA3IDAgMCAwIDE5LjkxIDFTMTguNzMuNjUgMTYgMi40OGExMy4zOCAxMy4zOCAwIDAgMC03IDBDNi4yNy42NSA1LjA5IDEgNS4wOSAxQTUuMDcgNS4wNyAwIDAgMCA1IDQuNzdhNS40NCA1LjQ0IDAgMCAwLTEuNSAzLjc4YzAgNS40MiAzLjMgNi42MSA2LjQ0IDdBMy4zNyAzLjM3IDAgMCAwIDkgMTguMTNWMjIiPjwvcGF0aD48L3N2Zz4=" /></a></li>
</nav>
        </header>
        <main id="content">
        <h1>Notes from debugging the Zephyr string copy function</h1>
<p>Today's bug is described in ussue 40874, and is described as:</p>
<blockquote>
<p>When I push this PR #40830 to validate string_alloc_copy() API with null parameter,
CI got blocked. Test stucks at arch_user_string_nlen().
It works fine on other platforms.</p>
</blockquote>
<p>The platform in question is <code>mps2_an521_ns</code>, and that's something that I can setup
locally with qemu.</p>
<h1>Reproducing</h1>
<p>I have some decent automation, so testing an individual test case like this is
a single command line</p>
<pre><code class="language-bash"><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    ; </span><span style="color:#8fa1b3;">j</span><span style="color:#c0c5ce;"> test-run mps2_an521_ns tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls
</span><span style="color:#8fa1b3;">python</span><span style="color:#c0c5ce;"> zephyr/scripts/twister</span><span style="color:#bf616a;"> -s</span><span style="color:#c0c5ce;"> tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls</span><span style="color:#bf616a;"> -p</span><span style="color:#c0c5ce;"> mps2_an521_ns</span><span style="color:#bf616a;"> -c
</span><span style="color:#8fa1b3;">ZEPHYR_BASE</span><span style="color:#c0c5ce;"> unset, using &quot;</span><span style="color:#a3be8c;">/home/jimbri01/src/c/zephyr/zephyr</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#8fa1b3;">Deleting</span><span style="color:#c0c5ce;"> output directory /home/jimbri01/src/c/zephyr/twister-out
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Zephyr version: v2.7.99-2049-g94e4a09752dc
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - JOBS: 12
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Using &#39;</span><span style="color:#a3be8c;">zephyr</span><span style="color:#c0c5ce;">&#39; toolchain.
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Building initial testcase list...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - 1 test scenarios (1 configurations) </span><span style="color:#8fa1b3;">selected,</span><span style="color:#c0c5ce;"> 0 configurations discarded due to filters.
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Adding tasks to the queue...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Added initial list of jobs to queue
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">ERROR</span><span style="color:#c0c5ce;">   - mps2_an521_ns             tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls FAILED: Timeout
</span><span style="color:#8fa1b3;">ERROR</span><span style="color:#c0c5ce;">   - see: /home/jimbri01/src/c/zephyr/twister-out/mps2_an521_ns/tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls/handler.log
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Total complete:    1/   1  100%  skipped:    0, failed:    1
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - 0 of 1 test configurations passed (0.00%)</span><span style="color:#8fa1b3;">,</span><span style="color:#c0c5ce;"> 1 failed, 0 skipped with 0 warnings in 157.96 seconds
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - In total 9 test cases were executed, 0 skipped on 1 out of total407 platforms (0.25%)
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - 0 test configurations executed on platforms, 1 test configurations were only built.
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Saving reports...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Writing xunit report /home/jimbri01/src/c/zephyr/twister-out/twister.xml...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Writing xunit report /home/jimbri01/src/c/zephyr/twister-out/twister_report.xml...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Run completed
</span><span style="color:#8fa1b3;">error:</span><span style="color:#c0c5ce;"> Recipe `</span><span style="color:#8fa1b3;">test-run</span><span style="color:#c0c5ce;">` failed on line 16 with exit code 1
</span></pre>
</code></pre>
<p>It seems to have reproduced, though it took 2.5 min ðŸ˜¬, so now we setup
the debugger.
I also have some automation around this, so it's similarly simple:</p>
<pre><code class="language-bash"><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    ; </span><span style="color:#8fa1b3;">j</span><span style="color:#c0c5ce;"> test-dbg mps2_an521_ns tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls
</span><span style="color:#8fa1b3;">python</span><span style="color:#c0c5ce;"> zephyr/scripts/twister</span><span style="color:#bf616a;"> -b -c -s</span><span style="color:#c0c5ce;"> tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls</span><span style="color:#bf616a;"> -p</span><span style="color:#c0c5ce;"> mps2_an521_ns &amp;&amp; </span><span style="color:#8fa1b3;">just</span><span style="color:#c0c5ce;"> _test-dbg mps2_an521_ns tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls
</span><span style="color:#8fa1b3;">ZEPHYR_BASE</span><span style="color:#c0c5ce;"> unset, using &quot;</span><span style="color:#a3be8c;">/home/jimbri01/src/c/zephyr/zephyr</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#8fa1b3;">Deleting</span><span style="color:#c0c5ce;"> output directory /home/jimbri01/src/c/zephyr/twister-out
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Zephyr version: v2.7.99-2049-g94e4a09752dc
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - JOBS: 24
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Using &#39;</span><span style="color:#a3be8c;">zephyr</span><span style="color:#c0c5ce;">&#39; toolchain.
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Building initial testcase list...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - 1 test scenarios (1 configurations) </span><span style="color:#8fa1b3;">selected,</span><span style="color:#c0c5ce;"> 0 configurations discarded due to filters.
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Adding tasks to the queue...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Added initial list of jobs to queue
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Total complete:    1/   1  100%  skipped:    0, failed:    0
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - 1 of 1 test configurations passed (100.00%)</span><span style="color:#8fa1b3;">,</span><span style="color:#c0c5ce;"> 0 failed, 0 skippedwith 0 warnings in 72.04 seconds
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - 0 test configurations executed on platforms, 1 test configurations were only built.
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Saving reports...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Writing xunit report /home/jimbri01/src/c/zephyr/twister-out/twister.xml...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Writing xunit report /home/jimbri01/src/c/zephyr/twister-out/twister_report.xml...
</span><span style="color:#8fa1b3;">INFO</span><span style="color:#c0c5ce;">    - Run completed
</span><span style="color:#8fa1b3;">The</span><span style="color:#c0c5ce;"> target architecture is set to &quot;</span><span style="color:#a3be8c;">armv8.1-m.main</span><span style="color:#c0c5ce;">&quot;.
</span><span style="color:#8fa1b3;">add</span><span style="color:#c0c5ce;"> symbol table from file &quot;</span><span style="color:#a3be8c;">twister-out/mps2_an521_ns/tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls/zephyr/zephyr.elf</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#8fa1b3;">add</span><span style="color:#c0c5ce;"> symbol table from file &quot;</span><span style="color:#a3be8c;">twister-out/mps2_an521_ns/tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls/tfm/bin/tfm_s.elf</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#8fa1b3;">add</span><span style="color:#c0c5ce;"> symbol table from file &quot;</span><span style="color:#a3be8c;">twister-out/mps2_an521_ns/tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls/tfm/bin/bl2.elf</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#8fa1b3;">CPU</span><span style="color:#c0c5ce;"> Reset (CPU 0)
</span><span style="color:#bf616a;">R00</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R01</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R02</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R03</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R04</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R05</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R06</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R07</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R08</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R09</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R10</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R11</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R12</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R13</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R14</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R15</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">XPSR</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">40000000 </span><span style="color:#8fa1b3;">-Z--</span><span style="color:#c0c5ce;"> A NS priv-thread
</span><span style="color:#8fa1b3;">Invalid</span><span style="color:#c0c5ce;"> read at addr 0x10000000, size 4, region &#39;</span><span style="color:#a3be8c;">(null)</span><span style="color:#c0c5ce;">&#39;, reason: rejected
</span><span style="color:#8fa1b3;">Invalid</span><span style="color:#c0c5ce;"> read at addr 0x10000004, size 4, region &#39;</span><span style="color:#a3be8c;">(null)</span><span style="color:#c0c5ce;">&#39;, reason: rejected
</span><span style="color:#8fa1b3;">CPU</span><span style="color:#c0c5ce;"> Reset (CPU 1)
</span><span style="color:#bf616a;">R00</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R01</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R02</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R03</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R04</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R05</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R06</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R07</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R08</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R09</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R10</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R11</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R12</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R13</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R14</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R15</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">XPSR</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">40000000 </span><span style="color:#8fa1b3;">-Z--</span><span style="color:#c0c5ce;"> A NS priv-thread
</span><span style="color:#8fa1b3;">Invalid</span><span style="color:#c0c5ce;"> read at addr 0x10000000, size 4, region &#39;</span><span style="color:#a3be8c;">(null)</span><span style="color:#c0c5ce;">&#39;, reason: rejected
</span><span style="color:#8fa1b3;">Invalid</span><span style="color:#c0c5ce;"> read at addr 0x10000004, size 4, region &#39;</span><span style="color:#a3be8c;">(null)</span><span style="color:#c0c5ce;">&#39;, reason: rejected
</span><span style="color:#8fa1b3;">qemu-system-arm:</span><span style="color:#c0c5ce;"> warning: nic lan9118.0 has no peer
</span><span style="color:#8fa1b3;">CPU</span><span style="color:#c0c5ce;"> Reset (CPU 0)
</span><span style="color:#bf616a;">R00</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R01</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R02</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R03</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R04</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R05</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R06</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R07</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R08</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R09</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R10</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R11</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">R12</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R13</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000 </span><span style="color:#bf616a;">R14</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">ffffffff </span><span style="color:#bf616a;">R15</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">00000000
</span><span style="color:#bf616a;">XPSR</span><span style="color:#c0c5ce;">=</span><span style="color:#a3be8c;">40000000 </span><span style="color:#8fa1b3;">-Z--</span><span style="color:#c0c5ce;"> A S priv-thread
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">warning:</span><span style="color:#c0c5ce;"> No executable has been specified and target does not support
</span><span style="color:#8fa1b3;">determining</span><span style="color:#c0c5ce;"> executable automatically.  Try using the &quot;</span><span style="color:#a3be8c;">file</span><span style="color:#c0c5ce;">&quot; command.
</span><span style="color:#8fa1b3;">0x10000510</span><span style="color:#c0c5ce;"> in Reset_Handler ()
</span><span style="color:#8fa1b3;">Breakpoint</span><span style="color:#c0c5ce;"> 1 at 0x1000051a (2 locations)
</span><span style="color:#8fa1b3;">Breakpoint</span><span style="color:#c0c5ce;"> 2 at 0x1000057c (2 locations)
</span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">gdb</span><span style="color:#c0c5ce;">)
</span></pre>
</code></pre>
<h1>Initial inspection</h1>
<p>Let's examine the bug:</p>
<pre><code>...really SecureFault with SFSR.AUVIOL
...taking pending secure exception 7

^C
Program received signal SIGINT, Interrupt.
0x10085e7e in SecureFault_Handler ()
(gdb) bt
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBA, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBA, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
warning: no PSP thread stack unwinding supported.
#0  0x10085e7e in SecureFault_Handler ()
#1  &lt;signal handler called&gt;
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBA, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBA, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 2, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFB8, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
Invalid read at addr 0xFFFFFFBC, size 4, region '(null)', reason: rejected
warning: no PSP thread stack unwinding supported.
Backtrace stopped: previous frame identical to this frame (corrupt stack?)
(gdb)
</code></pre>
<p>Ah gdb, you seem to be failing to understand the armv8-m fault handling again.
Looks like we end up in a secure fault during this test.</p>
<h2>Decode the fault</h2>
<p>Since we have a secure fault, we can decode the relevant registers to get more
details about exactly what failed.
The secure fault is not platform-specific, so we can lookup the details in
the armv8-m architecture refrence manual (arm).</p>
<p>In particular we look at the Secure Fault Status &amp; Attribute Registers.</p>
<pre><code>(gdb) x/2wt 0xe000ede4
0xe000ede4:     00000000000000000000000000001000        00000000000000000000000000000000
</code></pre>
<p>So it looks to me like we have a Attribution Unit violation fault (bit 3, set),
and the fault address is not valid (bit 6, clear).
That's less helpful that I had hoped.</p>
<h1>Dive deaper into the code</h1>
<p>Let's take a break from the fault handler and narrow down the location of the
fault by stepping over and resetting.
We'll start with the test case's main:</p>
<ol>
<li>main</li>
<li>test_main</li>
<li>z_ztest_run_test_suite</li>
<li>5th involcation of run_test</li>
</ol>
<p>Now we get to thread dispatch, which would be troublesome to step through so we
could take a look at the code that spawns the thread to find something to
put a breakpoint on that will put us in the context of the new thread:</p>
<pre><code class="language-C"><pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static int </span><span style="color:#8fa1b3;">run_test</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> unit_test *</span><span style="color:#bf616a;">test</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> ret = TC_PASS;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">TC_START</span><span style="color:#c0c5ce;">(test-&gt;</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">IS_ENABLED</span><span style="color:#c0c5ce;">(CONFIG_MULTITHREADING)) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">k_thread_create</span><span style="color:#c0c5ce;">(&amp;ztest_thread, ztest_thread_stack,
</span><span style="color:#c0c5ce;">				</span><span style="color:#8fa1b3;">K_THREAD_STACK_SIZEOF</span><span style="color:#c0c5ce;">(ztest_thread_stack),
</span><span style="color:#c0c5ce;">				(k_thread_entry_t) test_cb, (</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> unit_test *)test,
</span><span style="color:#c0c5ce;">				</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, CONFIG_ZTEST_THREAD_PRIORITY,
</span><span style="color:#c0c5ce;">				test-&gt;</span><span style="color:#bf616a;">thread_options </span><span style="color:#c0c5ce;">| K_INHERIT_PERMS,
</span><span style="color:#c0c5ce;">					K_FOREVER);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(test-&gt;</span><span style="color:#bf616a;">name </span><span style="color:#c0c5ce;">!= </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">			</span><span style="color:#8fa1b3;">k_thread_name_set</span><span style="color:#c0c5ce;">(&amp;ztest_thread, test-&gt;</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">		}
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">k_thread_start</span><span style="color:#c0c5ce;">(&amp;ztest_thread);
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">k_thread_join</span><span style="color:#c0c5ce;">(&amp;ztest_thread, K_FOREVER);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		test_result = </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">run_test_functions</span><span style="color:#c0c5ce;">(test);
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">...
</span></pre>
</code></pre>
<p>So it looks like we could set a breakpoint at <code>test_cb</code> and get there.
However, looking at test_cb, I think we can be more specific if we are able
to decode the <code>struct unit_test</code> that we last saw before a fault.</p>
<pre><code>(gdb)
z_ztest_run_test_suite (suite=0x28100050 &lt;_syscalls.12+80&gt;,
    name=0x10e414 &quot;syscalls&quot;)
    at /home/jimbri01/src/c/zephyr/zephyr/subsys/testsuite/ztest/src/ztest.c:421
421                     fail += run_test(suite);
(gdb) n

Breakpoint 3, 0x10085e7e in SecureFault_Handler ()
(gdb) p *((struct unit_test*) 0x28100050)
$2 = {name = 0x10e451 &quot;test_user_string_alloc_copy&quot;,
  test = 0x100d99 &lt;test_user_string_alloc_copy&gt;,
  setup = 0x10b64b &lt;unit_test_noop&gt;,
  teardown = 0x10b64b &lt;unit_test_noop&gt;, thread_options = 4}
(gdb)
</code></pre>
<p>so we can put a breakpoint in <code>test_user_string_alloc_copy</code>, which matches
the description of the bug.</p>
<p>Looks like it worked:</p>
<pre><code>Breakpoint 7, test_user_string_alloc_copy () at /home/jimbri01/src/c/zephyr/zephyr/tests/kernel/mem_protect/syscalls/src/main.c:249
249             ret = string_alloc_copy(&quot;asdkajshdazskjdh&quot;);
(gdb) n
250             zassert_equal(ret, -2, &quot;got %d&quot;, ret);
(gdb)
252             ret = string_alloc_copy(
(gdb)
254             zassert_equal(ret, -1, &quot;got %d&quot;, ret);
(gdb)
256             ret = string_alloc_copy(kernel_string);
(gdb)
257             zassert_equal(ret, -1, &quot;got %d&quot;, ret);
(gdb)
259             ret = string_alloc_copy(&quot;this is a kernel string&quot;);
(gdb)
260             zassert_equal(ret, 0, &quot;string should have matched&quot;);
(gdb)
262             ret = string_alloc_copy(src);
(gdb)

Breakpoint 3, 0x10085e7e in SecureFault_Handler ()
(gdb) i
</code></pre>
<p>(Note: a newline without any command repeats the last command in gdb)</p>
<p>So it looks like we can confirm the description that the bug happens when
you try to pass an invalid pointer to <code>string_alloc_copy</code>:</p>
<pre><code>(gdb)
262             ret = string_alloc_copy(src);
(gdb) p src
$3 = 0xffffffff &lt;error: Cannot access memory at address 0xffffffff&gt;
</code></pre>
<p>So let's see what happens in <code>string_alloc_copy</code>.
It's a stub, se we pass through the systemcall interface:</p>
<pre><code>(gdb) s
string_alloc_copy (src=0xffffffff &lt;error: Cannot access memory at address 0xffffffff&gt;) at /home/jimbri01/src/c/zephyr/zephyr/include/syscall.h:103
103             ret = arch_is_user_context();
(gdb)
38              if (z_syscall_trap()) {
(gdb)
0x0010b6ae in z_syscall_trap ()
    at /home/jimbri01/src/c/zephyr/zephyr/include/syscall.h:103
103             ret = arch_is_user_context();
(gdb)
arch_is_user_context () at /home/jimbri01/src/c/zephyr/zephyr/include/arch/arm/aarch32/syscall.h:172
172             __asm__ volatile(&quot;mrs %0, IPSR\n\t&quot; : &quot;=r&quot;(value));
(gdb)
173             if (value) {
(gdb)
178             return z_arm_thread_is_in_user_mode();
(gdb)
z_arm_thread_is_in_user_mode () at /home/jimbri01/src/c/zephyr/zephyr/arch/arm/core/aarch32/cortex_m/thread.c:15
15              value = __get_CONTROL();
(gdb)
__get_CONTROL ()
    at /home/jimbri01/src/c/zephyr/modules/hal/cmsis/CMSIS/Core/Include/cmsis_gcc.h:975
975       __ASM volatile (&quot;MRS %0, control&quot; : &quot;=r&quot; (result) );
(gdb)
z_arm_thread_is_in_user_mode () at /home/jimbri01/src/c/zephyr/zephyr/arch/arm/core/aarch32/cortex_m/thread.c:16
16              return (value &amp; CONTROL_nPRIV_Msk) != 0;
(gdb)
string_alloc_copy (src=0xffffffff &lt;error: Cannot access memory at address 0xffffffff&gt;) at /home/jimbri01/src/c/zephyr/zephyr/include/syscall.h:106
106             return ret;
(gdb)
35      static inline int string_alloc_copy(char * src)
(gdb) s
string_alloc_copy (
    src=0xffffffff &lt;error: Cannot access memory at address 0xffffffff&gt;)
    at /home/jimbri01/src/c/zephyr/twister-out/mps2_an521_ns/tests/kernel/mem_protect/syscalls/kernel.memory_protection.syscalls/zephyr/include/generated/syscalls/test_syscalls.h:40
40                      return (int) arch_syscall_invoke1(*(uintptr_t *)&amp;src, K_SYSCALL_STRING_ALLOC_COPY);
(gdb)
arch_syscall_invoke1 (call_id=278, arg1=4294967295)
    at /home/jimbri01/src/c/zephyr/zephyr/include/arch/arm/aarch32/syscall.h:141
141             register uint32_t ret __asm__(&quot;r0&quot;) = arg1;
(gdb)
142             register uint32_t r6 __asm__(&quot;r6&quot;) = call_id;
(gdb)
144             __asm__ volatile(&quot;svc %[svid]\n&quot;
(gdb)
Taking exception 2 [SVC]
...taking pending nonsecure exception 11
warning: no PSP thread stack unwinding supported.
z_arm_svc () at /home/jimbri01/src/c/zephyr/zephyr/arch/arm/core/aarch32/swap_helper.S:433
</code></pre>
<p>I'm stepping one line at a time, to be sure we hit the line that causes a
fault.
I'm omitting the rest of the gdb log until I hit something relevant for
brevity.</p>
<pre><code>z_vrfy_string_alloc_copy (
    src=0xffffffff &lt;error: Cannot access memory at address 0xffffffff&gt;)
    at /home/jimbri01/src/c/zephyr/zephyr/tests/kernel/mem_protect/syscalls/src/main.c:69
69              src_copy = z_user_string_alloc_copy((char *)src, BUF_SIZE);
(gdb)
z_user_string_alloc_copy (src=0xffffffff &lt;error: Cannot access memory at address 0xffffffff&gt;, maxlen=maxlen@entry=32) at /home/jimbri01/src/c/zephyr/zephyr/kernel/userspace.c:789

789             actual_len = z_user_string_nlen(src, maxlen, &amp;err);
(gdb)
0x00109ce6 in z_user_string_nlen (err=&lt;optimized out&gt;, maxlen=&lt;optimized out&gt;, src=&lt;optimized out&gt;) at /home/jimbri01/src/c/zephyr/zephyr/include/syscall_handler.h:207
207             return arch_user_string_nlen(src, maxlen, err);
(gdb)
789             actual_len = z_user_string_nlen(src, maxlen, &amp;err);
(gdb)
z_user_string_nlen (err=0x28104368 &lt;priv_stacks+5064&gt;, maxlen=32,
    src=0xffffffff &lt;error: Cannot access memory at address 0xffffffff&gt;)
    at /home/jimbri01/src/c/zephyr/zephyr/include/syscall_handler.h:207
207             return arch_user_string_nlen(src, maxlen, err);
(gdb)
arch_user_string_nlen () at /home/jimbri01/src/c/zephyr/zephyr/arch/arm/core/aarch32/userspace.S:695
695         push {r0, r1, r2, r4, r5, lr}
(gdb)
702         mov.w r3, #-1
(gdb)
704         str r3, [sp, #4]
(gdb)
707         movs r3, #0         /* r3 is the counter */
(gdb)
z_arm_user_string_nlen_fault_start () at /home/jimbri01/src/c/zephyr/zephyr/arch/arm/core/aarch32/userspace.S:712
712         ldrb r5, [r0, r3]
(gdb)
Taking exception 4 [Data Abort]
...really SecureFault with SFSR.AUVIOL
...taking pending secure exception 7

Breakpoint 3, 0x10085e7e in SecureFault_Handler ()
</code></pre>
<p>Alright, so we expect that faults will catch any invalid pointers here, at
the faulting line of asm:</p>
<pre><code>strlen_loop:
z_arm_user_string_nlen_fault_start:
    /* r0 contains the string. r5 = *(r0 + r3]). This could fault. */
    ldrb r5, [r0, r3]
</code></pre>
<p>Well, that'll cause faults when passed an invalid pointer.
My hypothesis is that Zepyhr expects to be able to handle this exception,
but TF-M gets the exception.</p>
<h1>Testing the Hypothesis</h1>
<p>This should be easy enough to test, as we can falsify the hypothesis by
inspecting the address of the TF-M and Zephyr fault handlers and compare
with the fault handler address.
I'm going to use nm piped to rg to handle this task:</p>
<pre><code class="language-bash"><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    ; </span><span style="color:#8fa1b3;">fd</span><span style="color:#c0c5ce;"> zephyr.elf | </span><span style="color:#8fa1b3;">xargs</span><span style="color:#c0c5ce;"> arm-none-eabi-nm | </span><span style="color:#8fa1b3;">rg</span><span style="color:#c0c5ce;"> SecureFault
</span><span style="color:#65737e;"># Nothing
</span></pre>
</code></pre>
<p>Right, Zephyr does not have a secure fault handler, and if it did, it would
be called something like <code>z_arm_secure_fault</code>.
So we hit something called <code>SecureFault_Handler</code> at <code>0x10085e7e</code>.
Searching the tfm firmware for that symbol yeilds a hit:</p>
<pre><code class="language-bash"><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    ; </span><span style="color:#8fa1b3;">fd</span><span style="color:#c0c5ce;"> tfm_s.elf | </span><span style="color:#8fa1b3;">xargs</span><span style="color:#c0c5ce;"> arm-none-eabi-nm | </span><span style="color:#8fa1b3;">rg</span><span style="color:#c0c5ce;"> SecureFault
</span><span style="color:#8fa1b3;">10085e7e</span><span style="color:#c0c5ce;"> T SecureFault_Handler
</span><span style="color:#8fa1b3;">10085e7e</span><span style="color:#c0c5ce;"> T SecureFault_Handler
</span></pre>
</code></pre>
<p>So it's the TF-M handler that we're hitting, which explains why we don't
have file and line number information.</p>
<h1>Conclusion</h1>
<p>I think this is a much more complex problem to resolve than could be covered
in a short period of time, as correcting this would involve setting something
up to ensure that Zephyr can handle these sorts of faults.</p>
<p>Instead, I'm recomending that we mark all armv8-M Non-Secure, <code>_ns</code> suffix,
targets as not supporting the null checking to unblock the current PR.
Further, we should mark that this test suite should remove all targets that
have <code>CONFIG_NULL_POINTER_EXCEPTION_DETECTION_NONE=y</code>.</p>

        </main>
    </body>
</html>
